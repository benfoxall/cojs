<style media="screen">
.CodeMirror {
  font-family:'Roboto Mono', monospace;
  height: auto;
}
.output {
  position: relative;
  padding: 0;
  display: flex;
}
iframe {
  width: 100%;
  /*height: 1em;*/
  border: none;
  /*margin-top: auto;*/
  max-height: 50vh
}
</style>


<li class="cell">
  <div class="input">
    <textarea ref:editor>{{code}}</textarea>
  </div>
  <div ref:output class="output" style="color: {{error?'#c00':''}}"></div>
</li>


<script>
export default {
  data() {
    return {
      code: '',
      output: ''
    }
  },

  oncreate () {

    this.set({code: this.get('cell').code})
    this.set({output: this.get('cell').output})


    const editable = this.refs.editor

    const cm = CodeMirror.fromTextArea(editable, {
      viewportMargin: Infinity
    })

    cm.on('changes', (e) => {
      const value = cm.getValue()
      if(lastValue == value) return
      lastValue = value

      this.fire('update',
        {
          code: value,
          ref: this.get('cell').ref
        }
      )
    })


    // will be overwritten
    this.get('cell').iframe.style.height = '1em';

    this.refs.output.appendChild(this.get('cell').iframe)


    let lastValue
    const listener = (e) => {
      if(lastValue == editable.value) return
      lastValue = editable.value

      console.log("LISTNEER FIRED", e)

      this.fire('update',
        {
          code: editable.value,
          ref: this.get('cell').ref
        }
      )

    }

    this.get('cell').addOutputListener((err, output) => {
      this.set({
        error: !!err,
        output: err || output
      })

    })

    // editable.addEventListener("DOMNodeInserted", listener, false)
    // editable.addEventListener("DOMNodeRemoved", listener, false)
    // editable.addEventListener("DOMCharacterDataModified", listener, false)


    editable.addEventListener("keydown", listener, false)
    editable.addEventListener("keyup", listener, false)
    editable.addEventListener("change", listener, false)

  }
}
</script>
